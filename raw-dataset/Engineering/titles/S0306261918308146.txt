Peer-to-peer energy sharing through a two-stage aggregated battery control in a community Microgrid 