An integrated approach for the analysis and control of grid connected energy storage systems 