If improvements are to be made in tuberculosis (TB) treatment, an increased understanding of disease in the lung is needed. Studies have shown that bacteria in a less metabolically active state, associated with the presence of lipid bodies, are less susceptible to antibiotics, and recent results have highlighted the disparity in concentration of different compounds into lesions. Treatment success therefore depends critically on the responses of the individual bacteria that constitute the infection. We propose a hybrid, individual-based approach that analyses spatio-temporal dynamics at the cellular level, linking the behaviour of individual bacteria and host cells with the macroscopic behaviour of the microenvironment. The individual elements (bacteria, macrophages and T cells) are modelled using cellular automaton (CA) rules, and the evolution of oxygen, drugs and chemokine dynamics are incorporated in order to study the effects of the microenvironment in the pathological lesion. We allow bacteria to switch states depending on oxygen concentration, which affects how they respond to treatment. This is the first multiscale model of its type to consider both oxygen-driven phenotypic switching of the Mycobacterium tuberculosis and antibiotic treatment. Using this model, we investigate the role of bacterial cell state and of initial bacterial location on treatment outcome. We demonstrate that when bacteria are located further away from blood vessels, less favourable outcomes are more likely, i.e. longer time before infection is contained/cleared, treatment failure or later relapse. We also show that in cases where bacteria remain at the end of simulations, the organisms tend to be slower-growing and are often located within granulomas, surrounded by caseous material.