2D quantum gravity on compact Riemann surfaces and two-loop partition function: A first principles approach 